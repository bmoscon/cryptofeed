# Backpack Exchange (Native)

## Overview
The native Backpack integration exposes the exchange through cryptofeed’s `Feed` API without relying on `ccxt`. It delivers consistent symbol normalization, ED25519 private channel access, proxy-aware transports, and structured telemetry.

## Enabling the Native Feed
- Set `CRYPTOFEED_BACKPACK_NATIVE=true` to register the native feed in `EXCHANGE_MAP`.
- When the flag is disabled, `CcxtBackpackFeed` remains the default to preserve existing behaviour.

## Configuration
Use `BackpackConfig` or pass a dictionary to `BackpackFeed(config=...)`:

```python
from cryptofeed.exchanges.backpack import BackpackConfig, BackpackFeed

config = BackpackConfig(
    enable_private_channels=True,
    auth={
        "api_key": "your-api-key",
        "public_key": "<32-byte hex or base64>",
        "private_key": "<32-byte hex or base64>",
    },
    proxies={"url": "socks5://proxy.example:1080"},
    window_ms=5000,
    use_sandbox=False,
)

feed = BackpackFeed(
    config=config,
    symbols=["BTC-USDT"],
    channels=["trades", "l2_book"],
)
```

Key points:
- Hex or base64 ED25519 keys are normalized to base64 internally.
- `window_ms` bounds (1–10,000) guard against replay attacks.
- Proxy overrides fall back to the global proxy injector when omitted.

## Authentication Flow
- REST and WebSocket calls use ED25519 signatures generated by `BackpackAuthHelper`.
- Timestamp precision: microseconds, encoded in `X-Timestamp` header.
- Required headers: `X-Timestamp`, `X-Window`, `X-API-Key`, `X-Signature`, optional `X-Passphrase`.
- Private channel subscriptions (`order.*`, `position.*`) automatically resend auth payloads after reconnects.

### Credential Validator
Use `python -m tools.backpack_auth_check --api-key <key> --public-key <pub> --private-key <priv>` to validate key formatting and preview signatures.

## Observability
- `BackpackFeed.metrics_snapshot()` exposes counters for websocket messages, reconnects, auth failures, and dropped payloads.
- `BackpackFeed.health()` returns a `BackpackHealthReport` indicating overall status and reasons for degradation (stale snapshots, dropped messages, etc.).
- Router logs include channel + symbol context for each processed message; dropped/unknown payloads emit warnings and increment `dropped_messages`.

## Proxy Support
- REST requests reuse `HTTPAsyncConn` with proxy injector integration.
- WebSocket session delegates to `WSAsyncConn`; when proxies are configured, the injector is consulted and usage is logged.
- Heartbeat pings ensure the session remains active; repeated failures raise `BackpackWebsocketError` and update metrics.

## Testing & Fixtures
- Unit coverage lives under `tests/unit/test_backpack_*.py`.
- Integration tests (`tests/integration/test_backpack_native.py`) use recorded fixtures from `tests/fixtures/backpack/` to validate snapshot + delta flows without live network calls.

## Migration Notes
- Default behaviour retains the ccxt-backed adapter until the native feature flag is enabled.
- See `docs/runbooks/backpack_migration.md` for rollout strategy and success criteria.
- `docs/migrations/backpack_ccxt.md` tracks the final deprecation checklist.
